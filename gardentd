-- CLEANUP
local playerGui = game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui")
local existing = playerGui and playerGui:FindFirstChild("AutoUpgrader")
if existing then existing:Destroy() end
local existingToggle = playerGui and playerGui:FindFirstChild("ToggleButton")
if existingToggle then existingToggle:Destroy() end

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Remote Functions
local RemoteFunctions = ReplicatedStorage:WaitForChild("RemoteFunctions")
local UpgradeUnit = RemoteFunctions:WaitForChild("UpgradeUnit")
local PlaceUnit = RemoteFunctions:WaitForChild("PlaceUnit")
local SellUnit = RemoteFunctions:WaitForChild("SellUnit")

-- State
local state = {
    isAutoUpgrading = false,
    selectedUnits = {},
    upgradeAll = false,
    visualBoxes = {},
    recordedUnits = {},
    currentTab = "upgrade",
    lastUpgradeTime = {},
    guiVisible = true,
    isDeleteMode = false,
    selectedForDeletion = {},
    knownUnits = {},
    lastUnitCount = 0
}

-- Utility Functions
local function getAllUnits()
    local units = {}
    local entities = workspace:FindFirstChild("Map") and workspace.Map:FindFirstChild("Entities")
    if not entities then return {} end
    
    for _, unit in ipairs(entities:GetChildren()) do
        if unit:IsA("Model") and string.sub(unit.Name, 1, 5) == "unit_" and unit:FindFirstChild("OwnedIndicator") then
            local id = unit:GetAttribute("ID")
            if id and typeof(id) == "number" then
                table.insert(units, {Name = unit.Name, ID = id, Model = unit})
            end
        end
    end
    return units
end

local function detectNewPlacements()
    local currentUnits = getAllUnits()
    
    if #currentUnits > state.lastUnitCount then
        for _, unit in ipairs(currentUnits) do
            if not state.knownUnits[unit.ID] then
                if not state.recordedUnits[unit.Name] then
                    local model = unit.Model
                    local primaryPart = model:FindFirstChild("HumanoidRootPart") or model:FindFirstChild("Torso") or model:FindFirstChild("Part") or model.PrimaryPart
                    
                    if primaryPart then
                        state.recordedUnits[unit.Name] = {
                            name = unit.Name,
                            position = primaryPart.Position,
                            cframe = primaryPart.CFrame,
                            displayName = unit.Name:gsub("unit_", ""):gsub("_", " "):upper()
                        }
                        
                        print("ðŸ“ Recorded new unit type:", unit.Name, "at position:", primaryPart.Position)
                        updatePlacementList()
                    end
                end
                state.knownUnits[unit.ID] = true
            end
        end
    end
    state.lastUnitCount = #currentUnits
end

local function manageVisualBoxes()
    for id, box in pairs(state.visualBoxes) do
        box:Destroy()
    end
    state.visualBoxes = {}
    
    local units = getAllUnits()
    for _, unit in ipairs(units) do
        if state.upgradeAll or state.selectedUnits[unit.ID] then
            local humanoidRootPart = unit.Model:FindFirstChild("HumanoidRootPart") or unit.Model:FindFirstChild("Torso") or unit.Model:FindFirstChild("Part")
            if humanoidRootPart then
                local box = Instance.new("SelectionBox")
                box.Adornee = unit.Model
                box.Color3 = Color3.fromRGB(0, 255, 127)
                box.LineThickness = 0.15
                box.Transparency = 0.5
                box.Parent = workspace
                state.visualBoxes[unit.ID] = box
            end
        end
    end
end

-- Mobile Dragging Function
local function makeDraggable(frame)
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    local function onInputBegan(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end
    
    local function onInputChanged(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end
    
    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end
    
    frame.InputBegan:Connect(onInputBegan)
    UserInputService.InputChanged:Connect(onInputChanged)
    UserInputService.InputEnded:Connect(onInputEnded)
end

-- UI Helper Functions
local function createCorner(obj, radius)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, radius or 8)
    corner.Parent = obj
    return corner
end

local function createButton(parent, size, position, text, color, textSize)
    local button = Instance.new("TextButton")
    button.Size = size
    button.Position = position
    button.BackgroundColor3 = color
    button.BorderSizePixel = 0
    button.Text = text
    button.TextColor3 = Color3.new(1, 1, 1)
    button.Font = Enum.Font.GothamBold
    button.TextSize = textSize or 12
    button.Parent = parent
    createCorner(button, 6)
    return button
end

-- Create GUI
local toggleGui = Instance.new("ScreenGui")
toggleGui.Name = "ToggleButton"
toggleGui.ResetOnSpawn = false
toggleGui.Parent = playerGui

local toggleButton = Instance.new("ImageButton")
toggleButton.Size = UDim2.new(0, 30, 0, 30)
toggleButton.Position = UDim2.new(1, -40, 0.5, -15)
toggleButton.BackgroundTransparency = 1
toggleButton.Image = "rbxassetid://10723346871"
toggleButton.Parent = toggleGui
makeDraggable(toggleButton)

local mainGui = Instance.new("ScreenGui")
mainGui.Name = "AutoUpgrader"
mainGui.ResetOnSpawn = false
mainGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 320, 0, 450)
mainFrame.Position = UDim2.new(0, 50, 0, 50)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = mainGui
createCorner(mainFrame, 10)
makeDraggable(mainFrame)

-- Header
local headerFrame = Instance.new("Frame")
headerFrame.Size = UDim2.new(1, 0, 0, 50)
headerFrame.Position = UDim2.new(0, 0, 0, 0)
headerFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
headerFrame.BorderSizePixel = 0
headerFrame.Parent = mainFrame
createCorner(headerFrame, 10)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -20, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "ðŸš€ Auto Upgrader & Placer"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = headerFrame

-- Tab Container
local tabContainer = Instance.new("Frame")
tabContainer.Size = UDim2.new(1, -20, 0, 40)
tabContainer.Position = UDim2.new(0, 10, 0, 60)
tabContainer.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
tabContainer.BorderSizePixel = 0
tabContainer.Parent = mainFrame
createCorner(tabContainer, 8)

local upgradeTab = createButton(tabContainer, UDim2.new(0.5, -2, 1, -4), UDim2.new(0, 2, 0, 2), "â¬†ï¸ UPGRADE", Color3.fromRGB(70, 130, 255), 11)
local placementTab = createButton(tabContainer, UDim2.new(0.5, -2, 1, -4), UDim2.new(0.5, 2, 0, 2), "ðŸ“ PLACEMENT", Color3.fromRGB(50, 50, 60), 11)

-- Content Container
local contentContainer = Instance.new("Frame")
contentContainer.Size = UDim2.new(1, -20, 0, 340)
contentContainer.Position = UDim2.new(0, 10, 0, 110)
contentContainer.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
contentContainer.BorderSizePixel = 0
contentContainer.Parent = mainFrame
createCorner(contentContainer, 8)

-- Upgrade Content
local upgradeContent = Instance.new("Frame")
upgradeContent.Size = UDim2.new(1, 0, 1, 0)
upgradeContent.BackgroundTransparency = 1
upgradeContent.Parent = contentContainer

local upgradeControls = Instance.new("Frame")
upgradeControls.Size = UDim2.new(1, -20, 0, 50)
upgradeControls.Position = UDim2.new(0, 10, 0, 10)
upgradeControls.BackgroundTransparency = 1
upgradeControls.Parent = upgradeContent

local toggleUpgrade = createButton(upgradeControls, UDim2.new(0.6, -5, 0, 40), UDim2.new(0, 0, 0, 0), "ðŸ”´ OFF", Color3.fromRGB(220, 60, 60), 12)
local upgradeAll = createButton(upgradeControls, UDim2.new(0.4, 0, 0, 40), UDim2.new(0.6, 5, 0, 0), "All: OFF", Color3.fromRGB(50, 50, 60), 11)

local upgradeScroll = Instance.new("ScrollingFrame")
upgradeScroll.Size = UDim2.new(1, -20, 0, 270)
upgradeScroll.Position = UDim2.new(0, 10, 0, 70)
upgradeScroll.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
upgradeScroll.BorderSizePixel = 0
upgradeScroll.ScrollBarThickness = 6
upgradeScroll.ScrollBarImageColor3 = Color3.fromRGB(70, 130, 255)
upgradeScroll.Parent = upgradeContent
createCorner(upgradeScroll, 6)

-- Placement Content
local placementContent = Instance.new("Frame")
placementContent.Size = UDim2.new(1, 0, 1, 0)
placementContent.BackgroundTransparency = 1
placementContent.Visible = false
placementContent.Parent = contentContainer

local placementInfo = Instance.new("TextLabel")
placementInfo.Size = UDim2.new(1, -20, 0, 30)
placementInfo.Position = UDim2.new(0, 10, 0, 10)
placementInfo.BackgroundTransparency = 1
placementInfo.Text = "ðŸ’¡ Place units manually first to record them!"
placementInfo.TextColor3 = Color3.fromRGB(150, 150, 160)
placementInfo.Font = Enum.Font.Gotham
placementInfo.TextSize = 10
placementInfo.TextWrapped = true
placementInfo.Parent = placementContent

local placementControls = Instance.new("Frame")
placementControls.Size = UDim2.new(1, -20, 0, 40)
placementControls.Position = UDim2.new(0, 10, 0, 50)
placementControls.BackgroundTransparency = 1
placementControls.Parent = placementContent

local deleteToggle = createButton(placementControls, UDim2.new(0.5, -2, 1, 0), UDim2.new(0, 0, 0, 0), "ðŸ—‘ï¸ Delete: OFF", Color3.fromRGB(50, 50, 60), 10)
local deleteSelected = createButton(placementControls, UDim2.new(0.5, -2, 1, 0), UDim2.new(0.5, 2, 0, 0), "âŒ Delete (0)", Color3.fromRGB(220, 60, 60), 10)
deleteSelected.Visible = false

local placementScroll = Instance.new("ScrollingFrame")
placementScroll.Size = UDim2.new(1, -20, 0, 240)
placementScroll.Position = UDim2.new(0, 10, 0, 100)
placementScroll.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
placementScroll.BorderSizePixel = 0
placementScroll.ScrollBarThickness = 6
placementScroll.ScrollBarImageColor3 = Color3.fromRGB(255, 130, 70)
placementScroll.Parent = placementContent
createCorner(placementScroll, 6)

-- Functions
local function updateUpgradeList()
    for _, child in ipairs(upgradeScroll:GetChildren()) do
        if child:IsA("GuiObject") then child:Destroy() end
    end
    
    local units = getAllUnits()
    local yPos = 0
    
    for _, unit in ipairs(units) do
        local isSelected = state.selectedUnits[unit.ID] or state.upgradeAll
        local displayName = unit.Name:gsub("unit_", ""):gsub("_", " "):upper()
        
        local unitButton = createButton(upgradeScroll, UDim2.new(1, -10, 0, 35), UDim2.new(0, 5, 0, yPos), 
            (isSelected and "âœ… " or "â­• ") .. displayName .. " (ID: " .. unit.ID .. ")", 
            isSelected and Color3.fromRGB(60, 150, 80) or Color3.fromRGB(40, 40, 50), 10)
        
        unitButton.TextXAlignment = Enum.TextXAlignment.Left
        unitButton.Font = Enum.Font.Gotham
        
        unitButton.MouseButton1Click:Connect(function()
            if not state.upgradeAll then
                state.selectedUnits[unit.ID] = not state.selectedUnits[unit.ID]
                updateUpgradeList()
                manageVisualBoxes()
            end
        end)
        
        yPos = yPos + 40
    end
    
    upgradeScroll.CanvasSize = UDim2.new(0, 0, 0, yPos)
end

function updatePlacementList()
    for _, child in ipairs(placementScroll:GetChildren()) do
        if child:IsA("GuiObject") then child:Destroy() end
    end
    
    local yPos = 0
    
    for unitName, unitData in pairs(state.recordedUnits) do
        local isSelected = state.selectedForDeletion[unitName]
        local buttonText = state.isDeleteMode and 
            (isSelected and "âŒ " or "ðŸ—‘ï¸ ") .. unitData.displayName or 
            "ðŸ“ Place " .. unitData.displayName
        local buttonColor = state.isDeleteMode and 
            (isSelected and Color3.fromRGB(220, 60, 60) or Color3.fromRGB(80, 45, 45)) or 
            Color3.fromRGB(70, 130, 255)
        
        local unitButton = createButton(placementScroll, UDim2.new(1, -10, 0, 40), UDim2.new(0, 5, 0, yPos), 
            buttonText, buttonColor, 11)
        
        unitButton.MouseButton1Click:Connect(function()
            if state.isDeleteMode then
                state.selectedForDeletion[unitName] = not state.selectedForDeletion[unitName]
                updatePlacementList()
                
                local count = 0
                for _, selected in pairs(state.selectedForDeletion) do
                    if selected then count = count + 1 end
                end
                deleteSelected.Text = "âŒ Delete (" .. count .. ")"
            else
                local success, err = pcall(function()
                    PlaceUnit:InvokeServer(unitData.name, {
                        Valid = true,
                        Rotation = 0,
                        CF = unitData.cframe,
                        Position = unitData.position
                    })
                    print("ðŸ“ Placed unit:", unitData.name, "at position:", unitData.position)
                end)
                
                if not success then
                    warn("âŒ Failed to place unit", unitData.name, ":", err)
                end
            end
        end)
        
        yPos = yPos + 45
    end
    
    placementScroll.CanvasSize = UDim2.new(0, 0, 0, yPos)
end

local function switchTab(tab)
    state.currentTab = tab
    if tab == "upgrade" then
        upgradeTab.BackgroundColor3 = Color3.fromRGB(70, 130, 255)
        placementTab.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        upgradeContent.Visible = true
        placementContent.Visible = false
        updateUpgradeList()
    else
        upgradeTab.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        placementTab.BackgroundColor3 = Color3.fromRGB(255, 130, 70)
        upgradeContent.Visible = false
        placementContent.Visible = true
        updatePlacementList()
    end
end

-- Button Events
toggleButton.MouseButton1Click:Connect(function()
    state.guiVisible = not state.guiVisible
    mainFrame.Visible = state.guiVisible
    toggleButton.Image = state.guiVisible and "rbxassetid://10723346871" or "rbxassetid://10723346959"
end)

toggleUpgrade.MouseButton1Click:Connect(function()
    state.isAutoUpgrading = not state.isAutoUpgrading
    toggleUpgrade.Text = state.isAutoUpgrading and "ðŸŸ¢ ON" or "ðŸ”´ OFF"
    toggleUpgrade.BackgroundColor3 = state.isAutoUpgrading and Color3.fromRGB(60, 200, 80) or Color3.fromRGB(220, 60, 60)
end)

upgradeAll.MouseButton1Click:Connect(function()
    state.upgradeAll = not state.upgradeAll
    upgradeAll.Text = "All: " .. (state.upgradeAll and "ON" or "OFF")
    upgradeAll.BackgroundColor3 = state.upgradeAll and Color3.fromRGB(60, 150, 80) or Color3.fromRGB(50, 50, 60)
    if state.upgradeAll then state.selectedUnits = {} end
    updateUpgradeList()
    manageVisualBoxes()
end)

deleteToggle.MouseButton1Click:Connect(function()
    state.isDeleteMode = not state.isDeleteMode
    state.selectedForDeletion = {}
    
    deleteToggle.Text = "ðŸ—‘ï¸ Delete: " .. (state.isDeleteMode and "ON" or "OFF")
    deleteToggle.BackgroundColor3 = state.isDeleteMode and Color3.fromRGB(220, 60, 60) or Color3.fromRGB(50, 50, 60)
    deleteSelected.Visible = state.isDeleteMode
    deleteSelected.Text = "âŒ Delete (0)"
    
    updatePlacementList()
end)

deleteSelected.MouseButton1Click:Connect(function()
    local deletedCount = 0
    for unitName, isSelected in pairs(state.selectedForDeletion) do
        if isSelected and state.recordedUnits[unitName] then
            print("ðŸ—‘ï¸ Deleted recorded unit:", state.recordedUnits[unitName].name)
            state.recordedUnits[unitName] = nil
            deletedCount = deletedCount + 1
        end
    end
    
    state.selectedForDeletion = {}
    deleteSelected.Text = "âŒ Delete (0)"
    updatePlacementList()
    
    if deletedCount > 0 then
        print("âœ… Deleted", deletedCount, "recorded units")
    end
end)

upgradeTab.MouseButton1Click:Connect(function() switchTab("upgrade") end)
placementTab.MouseButton1Click:Connect(function() switchTab("placement") end)

-- Main Loop
local function shouldUpgradeUnit(unit)
    if not state.isAutoUpgrading then return false end
    
    local currentTime = tick()
    local lastTime = state.lastUpgradeTime[unit.ID] or 0
    
    if currentTime - lastTime < 2 then return false end
    
    return state.upgradeAll or state.selectedUnits[unit.ID]
end

local upgradeConnection = RunService.Heartbeat:Connect(function()
    if not state.isAutoUpgrading then return end
    
    local units = getAllUnits()
    for _, unit in ipairs(units) do
        if shouldUpgradeUnit(unit) then
            local success, err = pcall(function()
                UpgradeUnit:InvokeServer(unit.ID)
                state.lastUpgradeTime[unit.ID] = tick()
                print("â¬†ï¸ Upgraded:", unit.Name, "ID:", unit.ID)
            end)
            
            if not success then
                warn("âŒ Failed to upgrade:", unit.ID, err)
            end
        end
    end
end)

local updateConnection = RunService.Heartbeat:Connect(function()
    if tick() % 1 < 0.016 then
        if state.currentTab == "upgrade" then
            updateUpgradeList()
        else
            updatePlacementList()
        end
        manageVisualBoxes()
        detectNewPlacements()
    end
end)

-- Initialize
switchTab("upgrade")
detectNewPlacements()

-- Cleanup
mainGui.AncestryChanged:Connect(function()
    if not mainGui.Parent then
        if upgradeConnection then upgradeConnection:Disconnect() end
        if updateConnection then updateConnection:Disconnect() end
        for _, box in pairs(state.visualBoxes) do box:Destroy() end
    end
end)

print("ðŸŽ¨ Clean Auto Upgrader & Placer loaded!")
print("ðŸ“± Mobile-friendly with organized layout!")
print("ðŸŽ¯ Toggle button (AU) to show/hide main GUI")
print("ðŸ“ Place units manually first to record them!")
print("ðŸ”„ All features working as intended!")
